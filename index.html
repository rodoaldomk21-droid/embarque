<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guanabara Check-in PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --blue: #004a99; --green: #28a745; --red: #dc3545; --bg: #f1f5f9; --wsapp: #25d366; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        header { background: var(--blue); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        .btn { border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; color: white; font-size: 16px; margin-top: 10px; display: block; text-align: center; text-decoration: none; }
        .btn-blue { background: var(--blue); }
        .btn-qr { background: #6b21a8; }
        .btn-whatsapp { background: var(--wsapp); }
        .btn-del { background: var(--red); width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; position: absolute; right: 15px; top: 15px; }
        .resumo-box { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
        .resumo-item { flex: 1; padding: 10px; border-radius: 10px; text-align: center; color: white; font-weight: bold; font-size: 14px; }
        .p-row { display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #eee; }
        .p-row.ok { background: #e6ffed; border-left: 6px solid var(--green); }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 15px; background: #000; display: none; }
        #loader { display:none; text-align:center; padding: 10px; color: var(--blue); font-weight: bold; }
        .p-info { margin-left:10px; flex-grow: 1; }
        .p-num { color: #d97706; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>

<header>GUANABARA - RECIFE</header>

<div id="view-menu" class="container">
    <div class="card">
        <h3>Nova Viagem</h3>
        <input type="time" id="input-hora" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px; box-sizing: border-box;">
        <input type="text" id="input-destino" placeholder="Destino (ex: Fortaleza)" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing: border-box;">
        <button class="btn btn-blue" onclick="adicionarViagem()">CRIAR LISTA</button>
    </div>
    <div id="lista-viagens-container"></div>
</div>

<div id="view-lista" class="container" style="display:none">
    <button onclick="irParaMenu()" style="background:none; border:none; color:var(--blue); font-weight:bold; margin-bottom:15px; cursor:pointer;">‚Üê VOLTAR</button>
    
    <div class="resumo-box">
        <div class="resumo-item" style="background: var(--green);">Embarcados: <span id="count-ok">0</span></div>
        <div class="resumo-item" style="background: var(--red);">Faltam: <span id="count-faltam">0</span></div>
    </div>

    <div class="card">
        <h2 id="titulo-viagem" style="margin-top:0"></h2>
        <div id="reader"></div>
        <button class="btn btn-qr" onclick="toggleScanner()">üì∑ ESCANEAR QR CODE</button>
        <button class="btn btn-blue" onclick="document.getElementById('file-input').click()">üì• CARREGAR PDF</button>
        <input type="file" id="file-input" accept="application/pdf" style="display:none">
        <div id="loader">‚öôÔ∏è LENDO BILHETES...</div>
    </div>

    <div id="passageiros-lista"></div>
    <div id="acoes-lista" style="display:none">
        <button class="btn btn-whatsapp" onclick="enviarWhatsApp()">üì± RESUMO WHATSAPP</button>
    </div>
</div>

<script>
    let viagens = JSON.parse(localStorage.getItem('gb_final_v30')) || [];
    let atualIdx = null;
    let html5QrCode = null;
    const audioBip = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');

    function salvar() { localStorage.setItem('gb_final_v30', JSON.stringify(viagens)); }

    function adicionarViagem() {
        const h = document.getElementById('input-hora').value;
        const d = document.getElementById('input-destino').value;
        if(!h || !d) return alert("Preencha os dados!");
        viagens.push({ id: Date.now(), hora: h, destino: d, passageiros: [] });
        salvar(); renderMenu();
    }

    function excluirViagem(index, event) {
        event.stopPropagation();
        if(confirm("Deseja apagar esta viagem definitivamente?")) {
            viagens.splice(index, 1);
            salvar();
            renderMenu();
        }
    }

    function renderMenu() {
        const c = document.getElementById('lista-viagens-container');
        c.innerHTML = "";
        viagens.forEach((v, i) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.cursor = 'pointer';
            div.onclick = () => abrirViagem(i);
            div.innerHTML = `
                <button class="btn btn-del" onclick="excluirViagem(${i}, event)">üóëÔ∏è</button>
                <strong>${v.hora} - ${v.destino}</strong><br>
                <small>${v.passageiros.length} passageiros total</small>
            `;
            c.appendChild(div);
        });
    }

    function abrirViagem(i) {
        atualIdx = i;
        document.getElementById('view-menu').style.display = 'none';
        document.getElementById('view-lista').style.display = 'block';
        document.getElementById('titulo-viagem').innerText = viagens[i].hora + " - " + viagens[i].destino;
        renderPassageiros();
    }

    function irParaMenu() {
        if(html5QrCode) html5QrCode.stop();
        document.getElementById('view-menu').style.display = 'block';
        document.getElementById('view-lista').style.display = 'none';
        renderMenu();
    }

    async function toggleScanner() {
        const r = document.getElementById('reader');
        audioBip.play().then(() => { audioBip.pause(); audioBip.currentTime = 0; }).catch(() => {});
        if(html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
            r.style.display = 'none';
            return;
        }
        r.style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
            const match = text.match(/(\d{6})[A-Z]{2}/);
            if(match) {
                const b = match[1];
                const p = viagens[atualIdx].passageiros.find(x => x.bilhete === b);
                if(p && !p.ok) {
                    p.ok = true;
                    audioBip.play();
                    salvar(); renderPassageiros();
                }
            }
        });
    }

    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('loader').style.display = 'block';
        const reader = new FileReader();
        reader.onload = async function() {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let encontrados = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                let lines = {};
                text.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if(!lines[y]) lines[y] = [];
                    lines[y].push({ x: it.transform[4], str: it.str });
                });
                Object.keys(lines).forEach(y => {
                    let lineStr = lines[y].sort((a,b) => a.x - b.x).map(it => it.str).join(" ").toUpperCase();
                    if ((lineStr.includes("RECIFE") || lineStr.includes("CAXANGA")) && /^\d{1,2}\s/.test(lineStr.trim())) {
                        let polt = lineStr.trim().match(/^(\d{1,2})/)[1];
                        let numeros6 = lineStr.match(/\b\d{6}\b/g);
                        let bilhete = numeros6 ? numeros6[numeros6.length - 1] : "N/A";
                        let nome = lineStr.replace(/^\d{1,2}/, '').split("RECIFE")[0].replace(/\d{7,}/g, '').replace(/\(.*\)/g, '').trim();
                        encontrados.push({ polt, nome, bilhete, ok: false });
                    }
                });
            }
            viagens[atualIdx].passageiros = encontrados.sort((a,b) => parseInt(a.polt) - parseInt(b.polt));
            salvar(); renderPassageiros();
            document.getElementById('loader').style.display = 'none';
        };
        reader.readAsArrayBuffer(file);
    });

    function renderPassageiros() {
        const l = document.getElementById('passageiros-lista');
        l.innerHTML = "";
        const pax = viagens[atualIdx].passageiros;
        
        // Atualizar Contadores
        const emb = pax.filter(p => p.ok).length;
        const falta = pax.length - emb;
        document.getElementById('count-ok').innerText = emb;
        document.getElementById('count-faltam').innerText = falta;

        document.getElementById('acoes-lista').style.display = pax.length ? "block" : "none";
        pax.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `p-row ${p.ok ? 'ok' : ''}`;
            div.innerHTML = `<input type="checkbox" ${p.ok ? 'checked' : ''} onclick="toggle(${i})">
                <div class="p-info"><strong>${p.polt} - ${p.nome}</strong><br><span class="p-num">BILHETE: ${p.bilhete}</span></div>`;
            l.appendChild(div);
        });
    }

    function toggle(i) { 
        viagens[atualIdx].passageiros[i].ok = !viagens[atualIdx].passageiros[i].ok; 
        salvar(); 
        renderPassageiros(); 
    }

    function enviarWhatsApp() {
        const v = viagens[atualIdx];
        const emb = v.passageiros.filter(p => p.ok).length;
        const faltas = v.passageiros.filter(p => !p.ok).map(p => p.polt);
        const agora = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        const msg = encodeURIComponent(`*RESUMO DE EMBARQUE*\n\nüïí *Hor√°rio:* ${v.hora}\n‚úÖ *Embarcados:* ${emb}\n‚ùå *Faltam:* ${faltas.length} (Polt: ${faltas.join(", ")})\nüèÅ *Sa√≠da:* ${agora}`);
        window.open(`https://wa.me/?text=${msg}`);
    }

    window.onload = renderMenu;
</script>
</body>
</html>
